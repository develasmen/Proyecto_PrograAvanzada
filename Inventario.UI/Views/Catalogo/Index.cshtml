@using System.Globalization
@using System.Linq
@using System.Web
@model List<Inventario.Abstracciones.ModelosParaUI.ProductoDto>

@{
    ViewBag.Title = "Catalogo de Productos";
    var hayProductos = Model.Any();
    var disponibles = Model.Count(p => p.Estado && p.CantidadEnStock > 0);
    var bajoStock = Model.Count(p => p.CantidadEnStock > 0 && p.CantidadEnStock < 10);
    var agotados = Model.Count(p => p.CantidadEnStock == 0);
}

<style>
    .catalogo-hero {
        background: linear-gradient(135deg, #2663eb, #5a8dee);
        color: #fff;
        border-radius: 24px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 25px 60px rgba(38, 99, 235, 0.35);
    }

    .catalogo-hero h1 {
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .hero-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
    }

    .hero-stats .chip {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 18px;
        padding: 1rem 1.25rem;
        backdrop-filter: blur(6px);
    }

    .hero-stats .chip h4 {
        margin: 0;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(255, 255, 255, 0.8);
    }

    .hero-stats .chip p {
        margin: 0;
        font-size: 2rem;
        font-weight: 700;
    }

    .catalogo-toolbar {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-top: 1.5rem;
    }

        .catalogo-toolbar .input-group {
            max-width: 420px;
        }

    .search-pill {
        border-radius: 999px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.45);
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(6px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    }

        .search-pill .input-group-text {
            background: transparent;
            border: none;
            color: #fff;
            padding-left: 1rem;
        }

        .search-pill input {
            border: none;
            background: transparent;
            color: #fff;
        }

            .search-pill input::placeholder {
                color: rgba(255, 255, 255, 0.85);
            }

    @@media (min-width: 768px) {
        .catalogo-toolbar {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }
    }

    #busqueda-catalogo {
        border-left: none;
        box-shadow: none;
        border-radius: 999px;
    }

    .catalogo-loading {
        font-size: 0.95rem;
        min-height: 24px;
        color: #fff;
    }

    .catalogo-container {
        display: flex;
        gap: 2rem;
        min-height: 60vh;
    }

    .productos-section {
        flex: 1;
        overflow-y: auto;
        padding-right: 1rem;
    }

    .productos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 1.5rem;
    }

    .producto-card {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
        padding: 1.5rem;
        transition: transform 0.25s ease, box-shadow 0.25s ease;
    }

    .producto-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 25px 55px rgba(15, 23, 42, 0.18);
    }

    .producto-imagen {
        width: 100%;
        height: 170px;
        border-radius: 14px;
        background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
        margin-bottom: 1rem;
        overflow: hidden;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .producto-imagen img {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 14px;
        z-index: 2;
    }

    .producto-imagen .icono-fallback {
        font-size: 2.4rem;
        color: #fff;
        z-index: 1;
    }

    .producto-imagen.sin-imagen .icono-fallback {
        display: flex !important;
    }

    .producto-imagen:not(.sin-imagen) .icono-fallback {
        display: none;
    }

    .producto-info h3 {
        font-size: 1.15rem;
        margin-bottom: 0.2rem;
        color: #1f2b4a;
    }

    .producto-marca {
        color: #7a8ca4;
        font-size: 0.9rem;
        margin-bottom: 0.6rem;
    }

    .producto-precio {
        font-size: 1.6rem;
        font-weight: 700;
        color: #00b58a;
        margin-bottom: 0.6rem;
    }

    .producto-stock {
        font-size: 0.9rem;
        color: #7a8ca4;
        margin-bottom: 1rem;
    }

    .stock-bajo {
        color: #ef476f;
        font-weight: 600;
    }

    .btn-agregar {
        width: 100%;
        padding: 0.75rem;
        background: linear-gradient(135deg, #2663eb, #5a8dee);
        color: #fff;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .btn-agregar:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(38, 99, 235, 0.3);
        }

        .btn-agregar:disabled {
            background: #c4c9d9;
            cursor: not-allowed;
        }

    .carrito-section {
        width: 420px;
        background: #fff;
        border-radius: 22px;
        box-shadow: 0 25px 55px rgba(15, 23, 42, 0.18);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        position: sticky;
        top: 0;
        height: fit-content;
        max-height: calc(100vh - 150px);
    }

    .carrito-item {
        border: 1px solid #eef1fa;
        border-radius: 16px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #f8fbff;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }

    .carrito-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.75rem;
        gap: 0.75rem;
    }

    .carrito-item-nombre {
        font-weight: 600;
        color: #1f2b4a;
        flex: 1;
    }

    .btn-eliminar {
        border: none;
        background: rgba(239, 71, 111, 0.12);
        color: #ef476f;
        width: 32px;
        height: 32px;
        border-radius: 10px;
        display: grid;
        place-items: center;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .btn-eliminar:hover {
        background: rgba(239, 71, 111, 0.2);
    }

    .carrito-item-controls {
        margin-bottom: 0.65rem;
    }

    .cantidad-control {
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
        border: 1px solid #dee3f3;
        border-radius: 999px;
        padding: 0.15rem;
        background: #fff;
    }

    .btn-cantidad {
        width: 36px;
        height: 36px;
        border: none;
        border-radius: 50%;
        background: transparent;
        font-size: 1.1rem;
        font-weight: 600;
        color: #2663eb;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
    }

    .btn-cantidad:hover:not(:disabled) {
        background: rgba(38, 99, 235, 0.12);
    }

    .btn-cantidad:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .cantidad-input {
        width: 55px;
        border: none;
        text-align: center;
        font-weight: 600;
        background: transparent;
    }

    .cantidad-input:focus {
        outline: none;
    }

    .carrito-item-precio {
        font-weight: 600;
        color: #1f2b4a;
        font-size: 0.95rem;
    }

    @@media (max-width: 1100px) {
        .catalogo-container {
            flex-direction: column;
        }

        .carrito-section {
            width: 100%;
            position: static;
            max-height: none;
        }
    }

    .carrito-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #eef1fa;
    }

    .carrito-badge {
        background: rgba(38, 99, 235, 0.15);
        color: #2663eb;
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        font-weight: 600;
    }

    .carrito-items {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 1rem;
    }

    .carrito-resumen {
        border-top: 2px solid #eef1fa;
        padding-top: 1rem;
    }

    .btn-finalizar,
    .btn-vaciar {
        width: 100%;
        border-radius: 12px;
        font-weight: 600;
    }

    .btn-finalizar {
        padding: 1rem;
        background: linear-gradient(135deg, #00c58a, #02b279);
        border: none;
        color: #fff;
        margin-top: 0.5rem;
    }

    .btn-vaciar {
        background: transparent;
        border: 1px dashed rgba(239, 71, 111, 0.5);
        color: #ef476f;
    }

    .alert-modern {
        border: none;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 15px 35px rgba(15, 23, 42, 0.1);
    }
</style>

<div class="container-fluid px-0">
    <section class="catalogo-hero">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start gap-4">
            <div>
                <p class="text-uppercase small mb-2">Modulo cliente</p>
                <h1><i class="fas fa-shopping-bag me-2"></i> Catalogo de Productos</h1>
                <p class="mb-0" style="max-width:540px;opacity:0.8;">
                    Explora el inventario disponible en tiempo real, agrega productos al carrito y completa tus pedidos con total control del stock.
                </p>
            </div>
            <div class="catalogo-toolbar">
                <div class="input-group search-pill">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="busqueda-catalogo" class="form-control" placeholder="Buscar por nombre, marca o SKU..." autocomplete="off" />
                </div>
                <div id="catalogo-loading" class="catalogo-loading text-white d-none">
                    <i class="fas fa-spinner fa-spin me-2"></i>Buscando productos...
                </div>
            </div>
        </div>
        <div class="hero-stats">
            <div class="chip">
                <h4>Disponibles</h4>
                <p>@disponibles</p>
            </div>
            <div class="chip">
                <h4>Bajo stock</h4>
                <p>@bajoStock</p>
            </div>
            <div class="chip">
                <h4>Agotados</h4>
                <p>@agotados</p>
            </div>
        </div>
    </section>

    <div class="catalogo-container">
        <div class="productos-section">
            <div id="catalogo-error" class="alert alert-modern alert-danger text-center d-none">
                <h4 class="alert-heading">Ocurrio un error</h4>
                <p class="mb-0">No pudimos cargar el catalogo. Intenta nuevamente.</p>
            </div>
            <div id="catalogo-vacio" class="alert alert-modern alert-info text-center @(hayProductos ? "d-none" : string.Empty)">
                <h4 class="alert-heading">No encontramos productos</h4>
                <p class="mb-0">Intenta ajustar el criterio de busqueda o regresa mas tarde.</p>
            </div>
            <div class="productos-grid @(hayProductos ? string.Empty : "d-none")" id="productos-grid">
                @foreach (var producto in Model)
                {
                    <div class="producto-card" data-producto-id="@producto.Id">
                        <div class="producto-imagen">
                            <div class="producto-imagen">
                                <img src="@Url.Action("ImagenDeProductoPorSKU", "Productos", new { sku = producto.SKU })"
                                     alt="@producto.Nombre"
                                     onload="this.style.opacity='1';"
                                     onerror="this.style.display='none'; this.parentElement.classList.add('sin-imagen');"
                                     style="opacity: 0; transition: opacity 0.3s;" />
                                <i class="fas fa-box icono-fallback"></i>
                            </div>
                        </div>

                        <div class="producto-info">
                            <h3>@producto.Nombre</h3>
                            <div class="producto-marca">@producto.Marca</div>
                            <div class="producto-precio">
                                <span class="text-muted d-block small">Precio base</span>
                                <strong>&#8353;@producto.Precio.ToString("N2")</strong>
                            </div>
                            <div class="producto-precio mt-1 d-flex justify-content-between align-items-center">
                                <span class="badge bg-secondary">@producto.PorcentajeIVA.ToString("0.##")% IVA</span>
                                <div class="fw-bold fs-5 text-primary">&#8353;@producto.PrecioConImpuestos.ToString("N2")</div>
                            </div>
                            <div class="producto-stock @(producto.CantidadEnStock < 10 ? "stock-bajo" : string.Empty)">
                                Stock: <span class="stock-valor">@producto.CantidadEnStock</span> unidades
                            </div>
                            <button class="btn-agregar"
                                    onclick="agregarAlCarrito(@producto.Id, '@Html.Raw(HttpUtility.JavaScriptStringEncode(producto.Nombre ?? string.Empty))', @producto.Precio.ToString(CultureInfo.InvariantCulture), @producto.CantidadEnStock)"
                                    @(producto.CantidadEnStock == 0 ? "disabled" : string.Empty)>
                                <i class="fas fa-cart-plus"></i> Agregar al Carrito
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="carrito-section">
            <div class="carrito-header">
                <h2 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Mi Carrito</h2>
                <div class="carrito-badge" id="carrito-badge">0</div>
            </div>

            <div class="carrito-items" id="carrito-items">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Cargando carrito...</p>
                </div>
            </div>

            <div class="carrito-resumen">
                <div class="resumen-linea d-flex justify-content-between">
                    <span>Total de productos:</span>
                    <span id="total-productos">0</span>
                </div>
                <div class="resumen-linea d-flex justify-content-between">
                    <span>Total de items:</span>
                    <span id="total-items">0</span>
                </div>
                <div class="resumen-linea d-flex justify-content-between">
                    <span>Subtotal:</span>
                    <span id="subtotal-precio">&#8353;0.00</span>
                </div>
                <div class="resumen-linea d-flex justify-content-between">
                    <span>IVA:</span>
                    <span id="iva-precio">&#8353;0.00</span>
                </div>
                <div class="resumen-linea d-flex justify-content-between text-success">
                    <span>Descuentos:</span>
                    <span id="descuento-precio">-&#8353;0.00</span>
                </div>
                <div class="resumen-linea resumen-total d-flex justify-content-between">
                    <span>TOTAL:</span>
                    <span id="total-precio">&#8353;0.00</span>
                </div>
                <div class="mt-3">
                    <label class="form-label small text-uppercase text-muted">Aplicar cupón</label>
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" id="input-cupon-global" placeholder="CODIGO" maxlength="50" autocomplete="off" />
                        <button class="btn btn-outline-primary" type="button" onclick="aplicarCuponDesdeResumen()">Aplicar</button>
                    </div>
                    <small class="text-muted d-block mt-1">Se aplicará al primer producto compatible del carrito.</small>
                </div>
                <button class="btn-finalizar" id="btn-finalizar" disabled onclick="finalizarCompra()">
                    <i class="fas fa-check-circle me-2"></i> Finalizar Compra
                </button>
                <button class="btn-vaciar" id="btn-vaciar" onclick="vaciarCarrito()" style="display: none;">
                    <i class="fas fa-trash"></i> Vaciar Carrito
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="~/Scripts/Catalogo/carrito.js"></script>
}
